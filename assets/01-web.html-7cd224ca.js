import{_ as n,p as s,q as a,a1 as t}from"./framework-7db056f4.js";const e={},p=t(`<h1 id="http-web-ç¼–ç¨‹" tabindex="-1"><a class="header-anchor" href="#http-web-ç¼–ç¨‹" aria-hidden="true">#</a> http/Web ç¼–ç¨‹</h1><h2 id="ç®€å•çš„-web-æœåŠ¡å™¨" tabindex="-1"><a class="header-anchor" href="#ç®€å•çš„-web-æœåŠ¡å™¨" aria-hidden="true">#</a> ç®€å•çš„ web æœåŠ¡å™¨</h2><p>ç”¨ go çš„ http åŒ…æ¥æ„å»ºä¸€ä¸ªç®€å•çš„ hello world æœåŠ¡å™¨</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;log&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">func</span> <span class="token function">helloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	errForm <span class="token operator">:=</span> r<span class="token punctuation">.</span><span class="token function">ParseForm</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> errForm <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>errForm<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	fmt<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Form<span class="token punctuation">)</span>
	<span class="token boolean">_</span><span class="token punctuation">,</span> err <span class="token operator">:=</span> fmt<span class="token punctuation">.</span><span class="token function">Fprint</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;Hello world ğŸˆ&quot;</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	log<span class="token punctuation">.</span><span class="token function">Println</span><span class="token punctuation">(</span><span class="token string">&quot;Server start...&quot;</span><span class="token punctuation">)</span>
	http<span class="token punctuation">.</span><span class="token function">HandleFunc</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> helloHandler<span class="token punctuation">)</span>
	err <span class="token operator">:=</span> http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:8888&quot;</span><span class="token punctuation">,</span> <span class="token boolean">nil</span><span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		log<span class="token punctuation">.</span><span class="token function">Fatalln</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>ä¸Šé¢çš„ä»£ç ï¼Œè¦ç¼–å†™ä¸€ä¸ª Web æœåŠ¡å™¨å¾ˆç®€å•ï¼Œåªè¦è°ƒç”¨ http åŒ…çš„ä¸¤ä¸ªå‡½æ•°å°±å¯ä»¥äº†ã€‚</p><blockquote><p>Go é€šè¿‡ç®€å•çš„å‡ è¡Œä»£ç å°±å·²ç»è¿è¡Œèµ·æ¥ä¸€ä¸ª Web æœåŠ¡äº†ï¼Œè€Œä¸”è¿™ä¸ª Web æœåŠ¡å†…éƒ¨æœ‰æ”¯æŒé«˜å¹¶å‘çš„ç‰¹æ€§</p></blockquote><h2 id="go-web-å¦‚ä½•å·¥ä½œ" tabindex="-1"><a class="header-anchor" href="#go-web-å¦‚ä½•å·¥ä½œ" aria-hidden="true">#</a> Go Web å¦‚ä½•å·¥ä½œ</h2><h3 id="æ¦‚å¿µ" tabindex="-1"><a class="header-anchor" href="#æ¦‚å¿µ" aria-hidden="true">#</a> æ¦‚å¿µ</h3><p>Go Web å·¥ä½œæ–¹å¼çš„æ¦‚å¿µ</p><ul><li><p>Requestï¼šç”¨æˆ·è¯·æ±‚çš„ä¿¡æ¯ï¼Œç”¨æ¥è§£æç”¨æˆ·çš„è¯·æ±‚ä¿¡æ¯ï¼ŒåŒ…æ‹¬ postã€getã€cookieã€url ç­‰ä¿¡æ¯</p></li><li><p>Responseï¼šæœåŠ¡å™¨éœ€è¦åé¦ˆç»™å®¢æˆ·ç«¯çš„ä¿¡æ¯</p></li><li><p>Connï¼šç”¨æˆ·çš„æ¯æ¬¡è¯·æ±‚é“¾æ¥</p></li><li><p>Handlerï¼šå¤„ç†è¯·æ±‚å’Œç”Ÿæˆè¿”å›ä¿¡æ¯çš„å¤„ç†é€»è¾‘</p></li></ul><h3 id="http-åŒ…è¿è¡Œæœºåˆ¶" tabindex="-1"><a class="header-anchor" href="#http-åŒ…è¿è¡Œæœºåˆ¶" aria-hidden="true">#</a> Http åŒ…è¿è¡Œæœºåˆ¶</h3><table><thead><tr><th>Web å·¥ä½œæ¨¡å¼æµç¨‹å›¾</th></tr></thead><tbody><tr><td><img src="https://user-images.githubusercontent.com/94043894/184097043-e54bf410-b0d9-4fee-a012-b20a6ea65d58.png" alt="image"></td></tr></tbody></table><ol><li><p>åˆ›å»º Listen Socket, ç›‘å¬æŒ‡å®šçš„ç«¯å£ï¼Œç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚åˆ°æ¥ã€‚</p></li><li><p>Listen Socket æ¥å—å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¾—åˆ° Client Socket, æ¥ä¸‹æ¥é€šè¿‡ Client Socket ä¸å®¢æˆ·ç«¯é€šä¿¡ã€‚</p></li><li><p>å¤„ç†å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œé¦–å…ˆä» Client Socket è¯»å– HTTP è¯·æ±‚çš„åè®®å¤´ï¼Œå¦‚æœæ˜¯ POST æ–¹æ³•ï¼Œè¿˜å¯èƒ½è¦è¯»å–å®¢æˆ·ç«¯æäº¤çš„æ•°æ®ï¼Œç„¶åäº¤ç»™ç›¸åº”çš„ handler å¤„ç†è¯·æ±‚ï¼Œhandler å¤„ç†å®Œæ¯•å‡†å¤‡å¥½å®¢æˆ·ç«¯éœ€è¦çš„æ•°æ®ï¼Œé€šè¿‡ Client Socket å†™ç»™å®¢æˆ·ç«¯ã€‚</p></li></ol><p>è¿™æ•´ä¸ªçš„è¿‡ç¨‹é‡Œé¢æˆ‘ä»¬åªè¦äº†è§£æ¸…æ¥šä¸‹é¢ä¸‰ä¸ªé—®é¢˜ï¼Œä¹Ÿå°±çŸ¥é“ Go æ˜¯å¦‚ä½•è®© Web è¿è¡Œèµ·æ¥äº†</p><ul><li>å¦‚ä½•ç›‘å¬ç«¯å£ï¼Ÿ</li><li>å¦‚ä½•æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼Ÿ</li><li>å¦‚ä½•åˆ†é… handlerï¼Ÿ</li></ul><h4 id="listenandserve-ç›‘å¬ç«¯å£" tabindex="-1"><a class="header-anchor" href="#listenandserve-ç›‘å¬ç«¯å£" aria-hidden="true">#</a> ListenAndServeï¼ˆç›‘å¬ç«¯å£ï¼‰</h4><p>é€šè¿‡ä¹‹å‰ç¼–å†™çš„ä»£ç å¯ä»¥å‘ç° Go æ˜¯é€šè¿‡ <code>ListenAndServe</code> æ¥å¤„ç†è¿™äº›äº‹æƒ…çš„</p><p><b>æºç å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span>addr <span class="token builtin">string</span><span class="token punctuation">,</span> handler Handler<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	server <span class="token operator">:=</span> <span class="token operator">&amp;</span>Server<span class="token punctuation">{</span>Addr<span class="token punctuation">:</span> addr<span class="token punctuation">,</span> Handler<span class="token punctuation">:</span> handler<span class="token punctuation">}</span>
	<span class="token keyword">return</span> server<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åˆå§‹åŒ–äº†ä¸€ä¸ª server å¯¹è±¡ï¼Œç„¶åè°ƒç”¨äº†è¯¥å¯¹è±¡ ListenAndServe æ–¹æ³•</p><p><b>æºç å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> srv<span class="token punctuation">.</span><span class="token function">shuttingDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> ErrServerClosed
	<span class="token punctuation">}</span>
	addr <span class="token operator">:=</span> srv<span class="token punctuation">.</span>Addr
	<span class="token keyword">if</span> addr <span class="token operator">==</span> <span class="token string">&quot;&quot;</span> <span class="token punctuation">{</span>
		addr <span class="token operator">=</span> <span class="token string">&quot;:http&quot;</span> <span class="token comment">//http é»˜è®¤ç«¯å£ï¼š80</span>
	<span class="token punctuation">}</span>
	ln<span class="token punctuation">,</span> err <span class="token operator">:=</span> net<span class="token punctuation">.</span><span class="token function">Listen</span><span class="token punctuation">(</span><span class="token string">&quot;tcp&quot;</span><span class="token punctuation">,</span> addr<span class="token punctuation">)</span>
	<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> err
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> srv<span class="token punctuation">.</span><span class="token function">Serve</span><span class="token punctuation">(</span>ln<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>ListenAndServe</code>è°ƒç”¨äº†<code>net.Listen(&quot;tcp&quot;, addr)</code>ï¼Œä¹Ÿå°±æ˜¯åº•å±‚ç”¨ TCP åè®®æ­å»ºäº†ä¸€ä¸ªæœåŠ¡ï¼Œæœ€åè°ƒç”¨<code>src.Serve</code>ç›‘æ§æˆ‘ä»¬è®¾ç½®çš„ç«¯å£ã€‚ç›‘æ§ä¹‹åå¦‚ä½•æ¥æ”¶å®¢æˆ·ç«¯çš„è¯·æ±‚å‘¢ï¼Ÿ</p><h4 id="server-serve-æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#server-serve-æ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚" aria-hidden="true">#</a> Server.Serveï¼ˆæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚ï¼‰</h4><p><b>éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>srv <span class="token operator">*</span>Server<span class="token punctuation">)</span> <span class="token function">Serve</span><span class="token punctuation">(</span>l net<span class="token punctuation">.</span>Listener<span class="token punctuation">)</span> <span class="token builtin">error</span> <span class="token punctuation">{</span>
	<span class="token operator">...</span>

	ctx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithValue</span><span class="token punctuation">(</span>baseCtx<span class="token punctuation">,</span> ServerContextKey<span class="token punctuation">,</span> srv<span class="token punctuation">)</span>
	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		rw<span class="token punctuation">,</span> err <span class="token operator">:=</span> l<span class="token punctuation">.</span><span class="token function">Accept</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
		<span class="token operator">...</span>

		connCtx <span class="token operator">:=</span> ctx
		<span class="token keyword">if</span> cc <span class="token operator">:=</span> srv<span class="token punctuation">.</span>ConnContext<span class="token punctuation">;</span> cc <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
			connCtx <span class="token operator">=</span> <span class="token function">cc</span><span class="token punctuation">(</span>connCtx<span class="token punctuation">,</span> rw<span class="token punctuation">)</span>
			<span class="token keyword">if</span> connCtx <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
				<span class="token function">panic</span><span class="token punctuation">(</span><span class="token string">&quot;ConnContext returned nil&quot;</span><span class="token punctuation">)</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
		tempDelay <span class="token operator">=</span> <span class="token number">0</span>
		c <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">newConn</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
		c<span class="token punctuation">.</span><span class="token function">setState</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>rwc<span class="token punctuation">,</span> StateNew<span class="token punctuation">,</span> runHooks<span class="token punctuation">)</span> <span class="token comment">// before Serve can return</span>
		<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span>connCtx<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™ä¸ªå‡½æ•°é‡Œé¢èµ·äº†ä¸€ä¸ª<code>for{}</code>ï¼Œé¦–å…ˆé€šè¿‡<code>Listener</code>æ¥æ”¶è¯·æ±‚ï¼š<code>l.Accept()</code>ï¼Œå…¶æ¬¡åˆ›å»ºä¸€ä¸ª<code>Connï¼šc := srv.newConn(rw)</code>ï¼Œæœ€åå•ç‹¬å¼€äº†ä¸€ä¸ª<code>goroutine</code>ï¼ŒæŠŠè¿™ä¸ªè¯·æ±‚çš„æ•°æ®å½“åšå‚æ•°æ‰”ç»™è¿™ä¸ª conn å»æœåŠ¡ï¼š<code>go c.serve(connCtx)</code>ã€‚è¿™ä¸ªå°±æ˜¯é«˜å¹¶å‘ä½“ç°äº†ï¼Œç”¨æˆ·çš„æ¯ä¸€æ¬¡è¯·æ±‚éƒ½æ˜¯åœ¨ä¸€ä¸ªæ–°çš„<code>goroutine</code>å»æœåŠ¡ï¼Œç›¸äº’ä¸å½±å“ã€‚</p><h4 id="conn-serve-å¤„ç†è¯·æ±‚" tabindex="-1"><a class="header-anchor" href="#conn-serve-å¤„ç†è¯·æ±‚" aria-hidden="true">#</a> conn.serveï¼ˆå¤„ç†è¯·æ±‚ï¼‰</h4><p><b>éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>c <span class="token operator">*</span>conn<span class="token punctuation">)</span> <span class="token function">serve</span><span class="token punctuation">(</span>ctx context<span class="token punctuation">.</span>Context<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>

	ctx<span class="token punctuation">,</span> cancelCtx <span class="token operator">:=</span> context<span class="token punctuation">.</span><span class="token function">WithCancel</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span> c<span class="token punctuation">.</span>cancelCtx <span class="token operator">=</span> cancelCtx
	<span class="token keyword">defer</span> <span class="token function">cancelCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	c<span class="token punctuation">.</span>r <span class="token operator">=</span> <span class="token operator">&amp;</span>connReader<span class="token punctuation">{</span>conn<span class="token punctuation">:</span> c<span class="token punctuation">}</span>
	c<span class="token punctuation">.</span>bufr <span class="token operator">=</span> <span class="token function">newBufioReader</span><span class="token punctuation">(</span>c<span class="token punctuation">.</span>r<span class="token punctuation">)</span>
	c<span class="token punctuation">.</span>bufw <span class="token operator">=</span> <span class="token function">newBufioWriterSize</span><span class="token punctuation">(</span>checkConnErrorWriter<span class="token punctuation">{</span>c<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token operator">&lt;&lt;</span><span class="token number">10</span><span class="token punctuation">)</span>

	<span class="token keyword">for</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">,</span> err <span class="token operator">:=</span> c<span class="token punctuation">.</span><span class="token function">readRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
        <span class="token operator">...</span>

		<span class="token comment">// HTTP cannot have multiple simultaneous active requests.[*]</span>
		<span class="token comment">// Until the server replies to this request, it can&#39;t read another,</span>
		<span class="token comment">// so we might as well run the handler in this goroutine.</span>
		<span class="token comment">// [*] Not strictly true: HTTP pipelining. We could let them all process</span>
		<span class="token comment">// in parallel even if their responses need to be serialized.</span>
		<span class="token comment">// But we&#39;re not going to implement HTTP pipelining because it</span>
		<span class="token comment">// was never deployed in the wild and the answer is HTTP/2.</span>
		serverHandler<span class="token punctuation">{</span>c<span class="token punctuation">.</span>server<span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> w<span class="token punctuation">.</span>req<span class="token punctuation">)</span>
		w<span class="token punctuation">.</span><span class="token function">cancelCtx</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token operator">...</span>

	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>conn é¦–å…ˆä¼šè§£æ request:<code>w, err := c.readRequest(ctx)</code></li><li>ç„¶åè·å–ç›¸åº”çš„ handler å»å¤„ç†è¯·æ±‚ï¼š<code>serverHandler{c.server}.ServeHTTP(w, w.req)</code></li></ul><h4 id="servehttp" tabindex="-1"><a class="header-anchor" href="#servehttp" aria-hidden="true">#</a> ServeHTTP</h4><p><b>éƒ¨åˆ†æºç å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">func</span> <span class="token punctuation">(</span>sh serverHandler<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw ResponseWriter<span class="token punctuation">,</span> req <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	handler <span class="token operator">:=</span> sh<span class="token punctuation">.</span>srv<span class="token punctuation">.</span>Handler
	<span class="token keyword">if</span> handler <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		handler <span class="token operator">=</span> DefaultServeMux
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> req<span class="token punctuation">.</span>RequestURI <span class="token operator">==</span> <span class="token string">&quot;*&quot;</span> <span class="token operator">&amp;&amp;</span> req<span class="token punctuation">.</span>Method <span class="token operator">==</span> <span class="token string">&quot;OPTIONS&quot;</span> <span class="token punctuation">{</span>
		handler <span class="token operator">=</span> globalOptionsHandler<span class="token punctuation">{</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
    <span class="token operator">...</span>
	handler<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>rw<span class="token punctuation">,</span> req<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>sh.srv.Handler</code>å°±æ˜¯æˆ‘ä»¬åˆšæ‰åœ¨è°ƒç”¨å‡½æ•°<code>ListenAndServe</code>æ—¶å€™çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œæˆ‘ä»¬å‰é¢ä¾‹å­ä¼ é€’çš„æ˜¯ nilï¼Œä¹Ÿå°±æ˜¯ä¸ºç©ºï¼Œé‚£ä¹ˆé»˜è®¤è·å–<code>handler = DefaultServeMux</code>,é‚£ä¹ˆè¿™ä¸ªå˜é‡ç”¨æ¥åšä»€ä¹ˆçš„å‘¢ï¼Ÿå¯¹ï¼Œè¿™ä¸ªå˜é‡å°±æ˜¯ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå®ƒç”¨æ¥åŒ¹é… url è·³è½¬åˆ°å…¶ç›¸åº”çš„ handle å‡½æ•°ï¼Œé‚£ä¹ˆè¿™ä¸ªæˆ‘ä»¬æœ‰è®¾ç½®è¿‡å—ï¼Ÿæœ‰ï¼Œæˆ‘ä»¬è°ƒç”¨çš„ä»£ç é‡Œé¢ç¬¬ä¸€å¥ä¸æ˜¯è°ƒç”¨äº†<code>http.HandleFunc(&quot;/&quot;, helloHandle)</code>å˜›ã€‚è¿™ä¸ªä½œç”¨å°±æ˜¯æ³¨å†Œäº†è¯·æ±‚<code>/</code>çš„è·¯ç”±è§„åˆ™ï¼Œå½“è¯·æ±‚ uri ä¸º&quot;/&quot;ï¼Œè·¯ç”±å°±ä¼šè½¬åˆ°å‡½æ•° helloHandleï¼ŒDefaultServeMux ä¼šè°ƒç”¨ ServeHTTP æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å†…éƒ¨å…¶å®å°±æ˜¯è°ƒç”¨ sayhelloName æœ¬èº«ï¼Œæœ€åé€šè¿‡å†™å…¥ response çš„ä¿¡æ¯åé¦ˆåˆ°å®¢æˆ·ç«¯ã€‚</p><h3 id="æ€»ç»“" tabindex="-1"><a class="header-anchor" href="#æ€»ç»“" aria-hidden="true">#</a> æ€»ç»“</h3><p><b>è¯¦ç»†çš„æ•´ä¸ªæµç¨‹å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</b></p><table><thead><tr><th>æµç¨‹å›¾</th></tr></thead><tbody><tr><td><img src="https://user-images.githubusercontent.com/94043894/184104915-4f852d3b-d750-4a98-939c-c643dbe279ee.png" alt="image"></td></tr></tbody></table><h2 id="go-çš„-http-åŒ…è¯¦è§£" tabindex="-1"><a class="header-anchor" href="#go-çš„-http-åŒ…è¯¦è§£" aria-hidden="true">#</a> Go çš„ http åŒ…è¯¦è§£</h2><p>Go çš„ http æœ‰ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½ï¼šConnã€ServeMux</p><h3 id="conn-çš„-goroutine" tabindex="-1"><a class="header-anchor" href="#conn-çš„-goroutine" aria-hidden="true">#</a> Conn çš„ goroutine</h3><p>ä¸æˆ‘ä»¬ä¸€èˆ¬ç¼–å†™çš„ http æœåŠ¡å™¨ä¸åŒï¼ŒGo ä¸ºäº†å®ç°é«˜å¹¶å‘å’Œé«˜æ€§èƒ½ï¼Œä½¿ç”¨äº† goroutines æ¥å¤„ç† Conn çš„è¯»å†™äº‹ä»¶ï¼Œè¿™æ ·æ¯ä¸ªè¯·æ±‚éƒ½èƒ½ä¿æŒç‹¬ç«‹ï¼Œç›¸äº’ä¸ä¼šé˜»å¡ï¼Œå¯ä»¥é«˜æ•ˆçš„å“åº”ç½‘ç»œäº‹ä»¶ã€‚è¿™æ˜¯ Go é«˜æ•ˆçš„ä¿è¯ã€‚</p><p><b>Go åœ¨ç­‰å¾…å®¢æˆ·ç«¯è¯·æ±‚é‡Œé¢æ˜¯è¿™æ ·å†™çš„ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>c<span class="token punctuation">,</span> err <span class="token operator">:=</span> srv<span class="token punctuation">.</span><span class="token function">newConn</span><span class="token punctuation">(</span>rw<span class="token punctuation">)</span>
<span class="token keyword">if</span> err <span class="token operator">!=</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
	<span class="token keyword">continue</span>
<span class="token punctuation">}</span>
<span class="token keyword">go</span> c<span class="token punctuation">.</span><span class="token function">serve</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è¿™é‡Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šåˆ›å»ºä¸€ä¸ª Connï¼Œè¿™ä¸ª Conn é‡Œé¢ä¿å­˜äº†è¯¥æ¬¡è¯·æ±‚çš„ä¿¡æ¯ï¼Œç„¶åå†ä¼ é€’åˆ°å¯¹åº”çš„ handlerï¼Œè¯¥ handler ä¸­ä¾¿å¯ä»¥è¯»å–åˆ°ç›¸åº”çš„ header ä¿¡æ¯ï¼Œè¿™æ ·ä¿è¯äº†æ¯ä¸ªè¯·æ±‚çš„ç‹¬ç«‹æ€§ã€‚</p><h3 id="servemux-çš„è‡ªå®šä¹‰" tabindex="-1"><a class="header-anchor" href="#servemux-çš„è‡ªå®šä¹‰" aria-hidden="true">#</a> ServeMux çš„è‡ªå®šä¹‰</h3><p>è®²è¿°<code>conn.server</code>çš„æ—¶å€™ï¼Œå…¶å®å†…éƒ¨æ˜¯è°ƒç”¨äº† http åŒ…é»˜è®¤çš„è·¯ç”±å™¨ï¼Œé€šè¿‡è·¯ç”±å™¨æŠŠæœ¬æ¬¡è¯·æ±‚çš„ä¿¡æ¯ä¼ é€’åˆ°äº†åç«¯çš„å¤„ç†å‡½æ•°ã€‚é‚£ä¹ˆè¿™ä¸ªè·¯ç”±å™¨æ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿ</p><p><b>ç»“æ„å¦‚ä¸‹ï¼š</b></p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> ServeMux <span class="token keyword">struct</span> <span class="token punctuation">{</span>
	mu sync<span class="token punctuation">.</span>RWMutex   <span class="token comment">//é”ï¼Œç”±äºè¯·æ±‚æ¶‰åŠåˆ°å¹¶å‘å¤„ç†ï¼Œå› æ­¤è¿™é‡Œéœ€è¦ä¸€ä¸ªé”æœºåˆ¶</span>
	m  <span class="token keyword">map</span><span class="token punctuation">[</span><span class="token builtin">string</span><span class="token punctuation">]</span>muxEntry  <span class="token comment">// è·¯ç”±è§„åˆ™ï¼Œä¸€ä¸ª string å¯¹åº”ä¸€ä¸ª mux å®ä½“ï¼Œè¿™é‡Œçš„ string å°±æ˜¯æ³¨å†Œçš„è·¯ç”±è¡¨è¾¾å¼</span>
	hosts <span class="token builtin">bool</span> <span class="token comment">// æ˜¯å¦åœ¨ä»»æ„çš„è§„åˆ™ä¸­å¸¦æœ‰ host ä¿¡æ¯</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>æ¥ç€çœ‹ä¸€ä¸‹ Handler çš„å®šä¹‰</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> Handler <span class="token keyword">interface</span> <span class="token punctuation">{</span>
	<span class="token function">ServeHTTP</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span>  <span class="token comment">// è·¯ç”±å®ç°å™¨</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>Handler</code> æ˜¯ä¸€ä¸ªæ¥å£ï¼Œä½†æ˜¯å‰ä¸€å°èŠ‚ä¸­çš„ <code>helloHandler</code> å‡½æ•°å¹¶æ²¡æœ‰å®ç° <code>ServeHTTP</code> è¿™ä¸ªæ¥å£ï¼Œä¸ºä»€ä¹ˆèƒ½æ·»åŠ å‘¢ï¼ŸåŸæ¥åœ¨ http åŒ…é‡Œé¢è¿˜å®šä¹‰äº†ä¸€ä¸ªç±»å‹ <code>HandlerFunc</code>,æˆ‘ä»¬å®šä¹‰çš„å‡½æ•° helloHandler å°±æ˜¯è¿™ä¸ª <code>HandlerFunc</code> è°ƒç”¨ä¹‹åçš„ç»“æœï¼Œè¿™ä¸ªç±»å‹é»˜è®¤å°±å®ç°äº† <code>ServeHTTP</code> è¿™ä¸ªæ¥å£ï¼Œå³æˆ‘ä»¬è°ƒç”¨äº† <code>HandlerFunc(f)</code>,å¼ºåˆ¶ç±»å‹è½¬æ¢ f æˆä¸º <code>HandlerFunc</code> ç±»å‹ï¼Œè¿™æ · f å°±æ‹¥æœ‰äº† <code>ServeHTTP</code> æ–¹æ³•ã€‚</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">type</span> HandlerFunc <span class="token keyword">func</span><span class="token punctuation">(</span>ResponseWriter<span class="token punctuation">,</span> <span class="token operator">*</span>Request<span class="token punctuation">)</span>

<span class="token comment">// ServeHTTP calls f(w, r).</span>
<span class="token keyword">func</span> <span class="token punctuation">(</span>f HandlerFunc<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">f</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>è·¯ç”±å™¨é‡Œé¢å­˜å‚¨å¥½äº†ç›¸åº”çš„è·¯ç”±è§„åˆ™ä¹‹åï¼Œé‚£ä¹ˆå…·ä½“çš„è¯·æ±‚åˆæ˜¯æ€ä¹ˆåˆ†å‘çš„å‘¢ï¼Ÿè¯·çœ‹ä¸‹é¢çš„ä»£ç ï¼Œé»˜è®¤çš„è·¯ç”±å™¨å®ç°äº†<code>ServeHTTP</code>ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>RequestURI <span class="token operator">==</span> <span class="token string">&quot;*&quot;</span> <span class="token punctuation">{</span>
		w<span class="token punctuation">.</span><span class="token function">Header</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;Connection&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;close&quot;</span><span class="token punctuation">)</span>
		w<span class="token punctuation">.</span><span class="token function">WriteHeader</span><span class="token punctuation">(</span>StatusBadRequest<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	h<span class="token punctuation">,</span> <span class="token boolean">_</span> <span class="token operator">:=</span> mux<span class="token punctuation">.</span><span class="token function">Handler</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span>
	h<span class="token punctuation">.</span><span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>å¦‚ä¸Šæ‰€ç¤ºè·¯ç”±å™¨æ¥æ”¶åˆ°è¯·æ±‚ä¹‹åï¼Œå¦‚æœæ˜¯é‚£ä¹ˆå…³é—­é“¾æ¥ï¼Œä¸ç„¶è°ƒç”¨ <code>mux.Handler(r)</code>è¿”å›å¯¹åº”è®¾ç½®è·¯ç”±çš„å¤„ç† Handlerï¼Œç„¶åæ‰§è¡Œ<code>h.ServeHTTP(w, r)</code></p><p>ä¹Ÿå°±æ˜¯è°ƒç”¨å¯¹åº”è·¯ç”±çš„ handler çš„ ServerHTTP æ¥å£ï¼Œé‚£ä¹ˆ <code>mux.Handler(r)</code>æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿ</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code>
<span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">Handler</span><span class="token punctuation">(</span>r <span class="token operator">*</span>Request<span class="token punctuation">)</span> <span class="token punctuation">(</span>h Handler<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>Method <span class="token operator">!=</span> <span class="token string">&quot;CONNECT&quot;</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> p <span class="token operator">:=</span> <span class="token function">cleanPath</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span><span class="token punctuation">;</span> p <span class="token operator">!=</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token punctuation">{</span>
			<span class="token boolean">_</span><span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> p<span class="token punctuation">)</span>
			<span class="token keyword">return</span> <span class="token function">RedirectHandler</span><span class="token punctuation">(</span>p<span class="token punctuation">,</span> StatusMovedPermanently<span class="token punctuation">)</span><span class="token punctuation">,</span> pattern
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span> mux<span class="token punctuation">.</span><span class="token function">handler</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Host<span class="token punctuation">,</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>mux <span class="token operator">*</span>ServeMux<span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span>host<span class="token punctuation">,</span> path <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">(</span>h Handler<span class="token punctuation">,</span> pattern <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
	<span class="token keyword">defer</span> mux<span class="token punctuation">.</span>mu<span class="token punctuation">.</span><span class="token function">RUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

	<span class="token comment">// Host-specific pattern takes precedence over generic ones</span>
	<span class="token keyword">if</span> mux<span class="token punctuation">.</span>hosts <span class="token punctuation">{</span>
		h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>host <span class="token operator">+</span> path<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> mux<span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">if</span> h <span class="token operator">==</span> <span class="token boolean">nil</span> <span class="token punctuation">{</span>
		h<span class="token punctuation">,</span> pattern <span class="token operator">=</span> <span class="token function">NotFoundHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>åŸæ¥ä»–æ˜¯æ ¹æ®ç”¨æˆ·è¯·æ±‚çš„ URL å’Œè·¯ç”±å™¨é‡Œé¢å­˜å‚¨çš„ map å»åŒ¹é…çš„ï¼Œå½“åŒ¹é…åˆ°ä¹‹åè¿”å›å­˜å‚¨çš„ handlerï¼Œè°ƒç”¨è¿™ä¸ª handler çš„<code>ServeHTTP</code>æ¥å£å°±å¯ä»¥æ‰§è¡Œåˆ°ç›¸åº”çš„å‡½æ•°äº†ã€‚</p><p>é€šè¿‡ä¸Šé¢è¿™ä¸ªä»‹ç»ï¼Œæˆ‘ä»¬äº†è§£äº†æ•´ä¸ªè·¯ç”±è¿‡ç¨‹ï¼ŒGo å…¶å®æ”¯æŒå¤–éƒ¨å®ç°çš„è·¯ç”±å™¨ <code>ListenAndServe</code>çš„ç¬¬äºŒä¸ªå‚æ•°å°±æ˜¯ç”¨ä»¥é…ç½®å¤–éƒ¨è·¯ç”±å™¨çš„ï¼Œå®ƒæ˜¯ä¸€ä¸ª Handler æ¥å£ï¼Œå³å¤–éƒ¨è·¯ç”±å™¨åªè¦å®ç°äº† Handler æ¥å£å°±å¯ä»¥ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è‡ªå·±å®ç°çš„è·¯ç”±å™¨çš„<code>ServeHTTP</code>é‡Œé¢å®ç°è‡ªå®šä¹‰è·¯ç”±åŠŸèƒ½ã€‚</p><p>å¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼Œæˆ‘ä»¬è‡ªå·±å®ç°äº†ä¸€ä¸ªç®€æ˜“çš„è·¯ç”±å™¨ï¼š</p><div class="language-go line-numbers-mode" data-ext="go"><pre class="language-go"><code><span class="token keyword">package</span> main

<span class="token keyword">import</span> <span class="token punctuation">(</span>
	<span class="token string">&quot;fmt&quot;</span>
	<span class="token string">&quot;net/http&quot;</span>
<span class="token punctuation">)</span>

<span class="token keyword">type</span> MyMux <span class="token keyword">struct</span> <span class="token punctuation">{</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token punctuation">(</span>p <span class="token operator">*</span>MyMux<span class="token punctuation">)</span> <span class="token function">ServeHTTP</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">if</span> r<span class="token punctuation">.</span>URL<span class="token punctuation">.</span>Path <span class="token operator">==</span> <span class="token string">&quot;/&quot;</span> <span class="token punctuation">{</span>
		<span class="token function">helloHandler</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
		<span class="token keyword">return</span>
	<span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">NotFound</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> r<span class="token punctuation">)</span>
	<span class="token keyword">return</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">helloHandler</span><span class="token punctuation">(</span>w http<span class="token punctuation">.</span>ResponseWriter<span class="token punctuation">,</span> r <span class="token operator">*</span>http<span class="token punctuation">.</span>Request<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	fmt<span class="token punctuation">.</span><span class="token function">Fprintf</span><span class="token punctuation">(</span>w<span class="token punctuation">,</span> <span class="token string">&quot;Hello myroute!&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">func</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	mux <span class="token operator">:=</span> <span class="token operator">&amp;</span>MyMux<span class="token punctuation">{</span><span class="token punctuation">}</span>
	http<span class="token punctuation">.</span><span class="token function">ListenAndServe</span><span class="token punctuation">(</span><span class="token string">&quot;:9090&quot;</span><span class="token punctuation">,</span> mux<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>é€šè¿‡å¯¹ http åŒ…çš„åˆ†æä¹‹åï¼Œç°åœ¨è®©æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹æ•´ä¸ªçš„ä»£ç æ‰§è¡Œè¿‡ç¨‹ã€‚</p><ul><li><p>é¦–å…ˆè°ƒç”¨ Http.HandleFunc æŒ‰é¡ºåºåšäº†å‡ ä»¶äº‹ï¼š</p><ol><li><p>è°ƒç”¨äº† DefaultServeMux çš„ HandleFunc</p></li><li><p>è°ƒç”¨äº† DefaultServeMux çš„ Handle</p></li><li><p>å¾€ DefaultServeMux çš„ <code>map[string]muxEntry</code> ä¸­å¢åŠ å¯¹åº”çš„ handler å’Œè·¯ç”±è§„åˆ™</p></li></ol></li><li><p>å…¶æ¬¡è°ƒç”¨ <code>http.ListenAndServe(&quot;:9090&quot;, nil)</code></p><p>æŒ‰é¡ºåºåšäº†å‡ ä»¶äº‹æƒ…ï¼š</p><ol><li><p>å®ä¾‹åŒ– Server</p></li><li><p>è°ƒç”¨ Server çš„ <code>ListenAndServe()</code></p></li><li><p>è°ƒç”¨ <code>net.Listen(&quot;tcp&quot;, addr)</code>ç›‘å¬ç«¯å£</p></li><li><p>å¯åŠ¨ä¸€ä¸ª for å¾ªç¯ï¼Œåœ¨å¾ªç¯ä½“ä¸­ Accept è¯·æ±‚</p></li><li><p>å¯¹æ¯ä¸ªè¯·æ±‚å®ä¾‹åŒ–ä¸€ä¸ª Connï¼Œå¹¶ä¸”å¼€å¯ä¸€ä¸ª goroutine ä¸ºè¿™ä¸ªè¯·æ±‚è¿›è¡ŒæœåŠ¡ <code>go c.serve()</code></p></li><li><p>è¯»å–æ¯ä¸ªè¯·æ±‚çš„å†…å®¹ <code>w, err := c.readRequest()</code></p></li><li><p>åˆ¤æ–­ handler æ˜¯å¦ä¸ºç©ºï¼Œå¦‚æœæ²¡æœ‰è®¾ç½® handlerï¼ˆè¿™ä¸ªä¾‹å­å°±æ²¡æœ‰è®¾ç½® handlerï¼‰ï¼Œhandler å°±è®¾ç½®ä¸º DefaultServeMux</p></li><li><p>è°ƒç”¨ handler çš„ ServeHttp</p></li><li><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œä¸‹é¢å°±è¿›å…¥åˆ° <code>DefaultServeMux.ServeHttp</code></p></li><li><p>æ ¹æ® request é€‰æ‹© handlerï¼Œå¹¶ä¸”è¿›å…¥åˆ°è¿™ä¸ª handler çš„ ServeHTTP</p><p><code>mux.handler(r).ServeHTTP(w, r)</code></p></li><li><p>é€‰æ‹© handlerï¼š</p><ol><li>åˆ¤æ–­æ˜¯å¦æœ‰è·¯ç”±èƒ½æ»¡è¶³è¿™ä¸ª requestï¼ˆå“ˆå¸Œè¡¨åŒ¹é… ServeMux çš„ muxEntryï¼‰</li><li>å¦‚æœæœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨è¿™ä¸ªè·¯ç”± handler çš„ ServeHTTP</li><li>å¦‚æœæ²¡æœ‰è·¯ç”±æ»¡è¶³ï¼Œè°ƒç”¨ NotFoundHandler çš„ ServeHTTP</li></ol></li></ol></li></ul>`,64),o=[p];function c(l,i){return s(),a("div",null,o)}const r=n(e,[["render",c],["__file","01-web.html.vue"]]);export{r as default};
