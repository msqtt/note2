# è§¦å‘å™¨ trigger

è§¦å‘å™¨æ˜¯ä¸è¡¨æœ‰å…³çš„æ•°æ®åº“å¯¹è±¡ï¼Œåœ¨æ»¡è¶³å®šä¹‰æ¡ä»¶æ—¶è§¦å‘ï¼Œå¹¶æ‰§è¡Œè§¦å‘å™¨ä¸­å®šä¹‰çš„è¯­å¥é›†åˆã€‚

> é¡¾åæ€ä¹‰ï¼Œå°±æ˜¯ç”±äº‹ä»¶è§¦å‘çš„è¯­å¥ "*Â´âˆ€`)*Â´âˆ€`)*Â´âˆ€`)\*Â´âˆ€`)"

## ç‰¹æ€§

1. æœ‰ begin end ä½“ï¼Œæ‰§è¡Œçš„è¯­å¥éœ€è¦å¡«å†™åœ¨å…¶ä¸­
2. è§¦å‘æ¡ä»¶ï¼šå¯ä»¥æ˜¯`I`,`D`,`U`(å¢åˆ æ”¹)
3. è§¦å‘æ—¶é—´ï¼šåœ¨å¢åˆ æ”¹å‰å
4. æ¯ä¸€æ¡è¯­å¥è§¦å‘æ‰§è¡Œ
5. è§¦å‘å™¨å®šä¹‰åœ¨è¡¨ä¸Šï¼Œé™„ç€åœ¨è¡¨ä¸Š

::: warning
å¯¹å¢åˆ æ”¹éå¸¸é¢‘ç¹çš„è¡¨ä¸Šåˆ‡è®°ä¸è¦ä½¿ç”¨è§¦å‘å™¨ï¼Œè§¦å‘å™¨æ˜¯é’ˆå¯¹æ¯ä¸€è¡Œçš„ï¼Œå› ä¸ºå®ƒä¼šéå¸¸æ¶ˆè€—èµ„æº;è§¦å‘å™¨å°½é‡å°‘çš„ä½¿ç”¨ï¼Œå› ä¸ºä¸ç®¡å¦‚ä½•ï¼Œå®ƒå¾ˆæ¶ˆè€—èµ„æºï¼Œå¦‚æœä½¿ç”¨çš„è¯è¦è°¨æ…çš„ä½¿ç”¨ï¼Œè‡³å°‘ç¡®ä¿è¯­å¥æ˜¯é«˜æ•ˆçš„ã€‚
:::

## æ ¼å¼

```sql
CREATE
    [DEFINER = { user | CURRENT_USER }]
TRIGGER trigger_name
trigger_time trigger_event
ON tbl_name FOR EACH ROW
ã€€ã€€[trigger_order]
trigger_body


# trigger_time: { BEFORE | AFTER }
# trigger_event: { INSERT | UPDATE | DELETE }
# trigger_order: { FOLLOWS | PRECEDES } other_trigger_name
```

### ä¸€æ¡è¯­å¥

`CREATE TRIGGER è§¦å‘å™¨å BEFORE|AFTER è§¦å‘äº‹ä»¶ ON è¡¨å FOR EACH ROW æ‰§è¡Œè¯­å¥;`

### å¤šæ¡è¯­å¥

```sql
CREATE TRIGGER è§¦å‘å™¨å BEFORE|AFTER è§¦å‘äº‹ä»¶

ON è¡¨å FOR EACH ROW

BEGIN

    æ‰§è¡Œè¯­å¥åˆ—è¡¨

END;
```

## NEW ä¸ OLD

NEW ä¸ OLD è¯¦è§£

MySQL ä¸­å®šä¹‰äº† NEW å’Œ OLDï¼Œç”¨æ¥è¡¨ç¤ºè§¦å‘å™¨çš„æ‰€åœ¨è¡¨ä¸­ï¼Œè§¦å‘äº†è§¦å‘å™¨çš„é‚£ä¸€è¡Œæ•°æ®ï¼Œæ¥å¼•ç”¨è§¦å‘å™¨ä¸­å‘ç”Ÿå˜åŒ–çš„è®°å½•å†…å®¹ï¼Œå…·ä½“åœ°ï¼š

1. åœ¨ `INSERT` å‹è§¦å‘å™¨ä¸­ï¼Œ`NEW` ç”¨æ¥è¡¨ç¤ºå°†è¦`ï¼ˆBEFOREï¼‰`æˆ–å·²ç»`ï¼ˆAFTERï¼‰`æ’å…¥çš„æ–°æ•°æ®ï¼›
2. åœ¨ `UPDATE` å‹è§¦å‘å™¨ä¸­ï¼Œ`OLD` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»è¢«ä¿®æ”¹çš„åŸæ•°æ®ï¼Œ`NEW` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»ä¿®æ”¹ä¸ºçš„æ–°æ•°æ®ï¼›
3. åœ¨ `DELETE` å‹è§¦å‘å™¨ä¸­ï¼Œ`OLD` ç”¨æ¥è¡¨ç¤ºå°†è¦æˆ–å·²ç»è¢«åˆ é™¤çš„åŸæ•°æ®ï¼›

### ä½¿ç”¨æ–¹æ³•

`NEW.columnName` ï¼ˆ`columnName` ä¸ºç›¸åº”æ•°æ®è¡¨æŸä¸€åˆ—åï¼‰

å¦å¤–ï¼Œ`OLD` æ˜¯åªè¯»çš„ï¼Œè€Œ `NEW` åˆ™å¯ä»¥åœ¨è§¦å‘å™¨ä¸­ä½¿ç”¨ `SET` èµ‹å€¼ï¼Œè¿™æ ·ä¸ä¼šå†æ¬¡è§¦å‘è§¦å‘å™¨ï¼Œé€ æˆå¾ªç¯è°ƒç”¨ï¼ˆå¦‚æ¯æ’å…¥ä¸€ä¸ªå­¦ç”Ÿå‰ï¼Œéƒ½åœ¨å…¶å­¦å·å‰åŠ â€œğŸ·â€ï¼‰ã€‚

```bash
mysql> CREATE TRIGGER upd_check BEFORE UPDATE ON account
    -> FOR EACH ROW
    -> BEGIN
    -> ã€€ã€€IF NEW.amount < 0 THEN
    -> ã€€ã€€ã€€ã€€SET NEW.amount = 0;
    -> ã€€ã€€ELSEIF NEW.amount > 100 THEN
    -> ã€€ã€€ã€€ã€€SET NEW.amount = 100;
    -> ã€€ã€€END IF;
    -> END
```

## æŸ¥çœ‹è§¦å‘å™¨

æŸ¥è¯¢æ‰€æœ‰è§¦å‘å™¨

`SHOW TRIGGERS`

é€šè¿‡`information_schema.triggers` è¡¨ä¸­æŸ¥çœ‹è§¦å‘å™¨ä¿¡æ¯

```sql
# æŸ¥çœ‹æ‰€æœ‰
mysql> select * from information_schema.triggers;

# å‡†ç¡®æŸ¥æ‰¾
mysql> select * from information_schema.triggers
    -> where trigger_name='upd_check';
```

## åˆ é™¤è§¦å‘å™¨

`DROP TRIGGER [IF EXISTS] [schema_name.]trigger_name`
