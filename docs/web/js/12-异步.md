# å¼‚æ­¥

é¢˜å¤–è¯ï¼Œ è¿™ä¸ªæ¨¡å—è™½ç„¶å±äº js ï¼Œä½†æ˜¯æˆ‘æƒ³ç”¨ ts æ¥å†™å®ä¾‹çœ‹çœ‹ã€‚

## å¼‚æ­¥å’ŒåŒæ­¥

é‚£ä¹ˆéƒ½çŸ¥é“ Javascript è¯­è¨€çš„æ‰§è¡Œç¯å¢ƒæ˜¯å•çº¿ç¨‹, ä¸ºäº†è§£å†³å› ä¸ºç½‘ç»œè¯·æ±‚ç­‰å¾…é€ æˆçš„é¡µé¢æ— å“åº”

Javascript è¯­è¨€å°†ä»»åŠ¡çš„æ‰§è¡Œæ¨¡å¼åˆ†æˆä¸¤ç§ï¼šåŒæ­¥ï¼ˆSynchronousï¼‰å’Œå¼‚æ­¥ï¼ˆAsynchronousï¼‰

åŒæ­¥ï¼šé¡¾åæ€ä¹‰ï¼Œä¸€æ¡æ¡è¯­å¥ä»ä¸Šåˆ°ä¸‹æ‰§è¡Œ

å¼‚æ­¥ï¼šå’ŒåŒæ­¥ä¸ä¸€æ ·ï¼Œä¸Šä¸€æ­¥è¯­å¥ä¹Ÿè®¸åœ¨ä¸‹é¢æ‰æ‰§è¡Œ

::: tip
æˆ‘å¾ˆå–œæ¬¢ js å¯¹äºå¼‚æ­¥ç¼–ç¨‹çš„å¤„ç†ï¼Œç®€å•æ˜“ç”¨ï¼Œæ²¡ lua coroutine é‚£ä¹ˆ æ‰å¤´å‘ï¼Œå“ˆå“ˆæˆ‘æ°´å¹³æ¯”è¾ƒä½:poop:
:::

## å¼‚æ­¥ç¼–ç¨‹

js å®ç°å¼‚æ­¥ç¼–ç¨‹å¯ä»¥æœ‰å››ç§æ–¹æ³•

1. å›è°ƒå‡½æ•°
2. äº‹ä»¶ç›‘å¬
3. å‘å¸ƒ/è®¢é˜…
4. Promises å¯¹è±¡
5. Worker

### å›è°ƒå‡½æ•°

å¾ˆç®€å•, å‡å¦‚æˆ‘éœ€è¦æ‰§è¡Œä¸€ä¸ªå¾ˆè€—æ—¶çš„å‡½æ•°`longTimeWork()`, ä¸ºäº†é¿å…é¡µé¢å¡åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ï¼Œå¯ä»¥å…ˆæ‰§è¡Œåç»­
çš„æ­¥éª¤ï¼ŒæŠŠéœ€è¦ç­‰å¾…æ‰§è¡Œçš„ä»£ç æ”¾è¿›å›è°ƒå‡½æ•°

```typescript
function longTimeWork(callback: () => void) {
  console.log("Start waitting...");
  setTimeout(() => {
    callback();
  }, 1000);
}

function otherThings() {
  console.log("World");
}

function afterWaiting() {
  console.log("Hello");
}

// need a waitting to start execute afterWaiting function
longTimeWork(afterWaiting);

otherThings();

// ç»“æœ
// Start waitting...
// World
// Hello
```

ä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œå¯ä»¥æŠŠåŒæ­¥æ“ä½œå˜æˆå¼‚æ­¥çš„ï¼Œä¼˜ç‚¹æ˜¯ç®€å•ã€å®¹æ˜“ç†è§£å’Œéƒ¨ç½²ï¼Œç¼ºç‚¹æ˜¯ä¸åˆ©äºä»£ç çš„é˜…è¯»å’Œç»´æŠ¤ï¼Œå„ä¸ªéƒ¨åˆ†ä¹‹é—´é«˜åº¦è€¦åˆï¼ˆCouplingï¼‰ï¼Œæµç¨‹ä¼šå¾ˆæ··ä¹±ï¼Œè€Œä¸”æ¯ä¸ªä»»åŠ¡åªèƒ½æŒ‡å®šä¸€ä¸ªå›è°ƒå‡½æ•°ï¼Œå‡å¦‚æ˜¯å‘è¯·æ±‚ï¼Œå¦‚æœæœ‰å¤šæ¬¡è¯·æ±‚æ“ä½œï¼Œé‚£ä¹ˆå°±è¦å†™å¾ˆå¤šå±‚åµŒå¥— :poop:

### äº‹ä»¶ç›‘å¬

è¿™é‡Œç”¨é˜®ä¸€å³°çš„ä¾‹å­

å¦ä¸€ç§æ€è·¯æ˜¯é‡‡ç”¨äº‹ä»¶é©±åŠ¨æ¨¡å¼ã€‚ä»»åŠ¡çš„æ‰§è¡Œä¸å–å†³äºä»£ç çš„é¡ºåºï¼Œè€Œå–å†³äºæŸä¸ªäº‹ä»¶æ˜¯å¦å‘ç”Ÿ

é‡‡ç”¨çš„ jQuery çš„å†™æ³•

```javascript
f1.on("done", f2);

function f1() {
  setTimeout(function () {
    // f1çš„ä»»åŠ¡ä»£ç 

    f1.trigger("done");
  }, 1000);
}
```

ä¸Šé¢è¿™è¡Œä»£ç çš„æ„æ€æ˜¯ï¼Œå½“ f1 å‘ç”Ÿ done äº‹ä»¶ï¼Œå°±æ‰§è¡Œ f2ã€‚ç„¶åï¼Œå¯¹ f1 è¿›è¡Œæ”¹å†™

`f1.trigger('done')`è¡¨ç¤ºï¼Œæ‰§è¡Œå®Œæˆåï¼Œç«‹å³è§¦å‘ done äº‹ä»¶ï¼Œä»è€Œå¼€å§‹æ‰§è¡Œ f2ã€‚

å¯ä»¥"å»è€¦åˆ"ï¼ˆDecouplingï¼‰ï¼Œæœ‰åˆ©äºå®ç°æ¨¡å—åŒ–ã€‚ç¼ºç‚¹æ˜¯æ•´ä¸ªç¨‹åºéƒ½è¦å˜æˆäº‹ä»¶é©±åŠ¨å‹ï¼Œ
è¿è¡Œæµç¨‹ä¼šå˜å¾—å¾ˆä¸æ¸…æ™°

### å‘å¸ƒ/è®¢é˜…

æˆ‘ä»¬å‡å®šï¼Œå­˜åœ¨ä¸€ä¸ª"ä¿¡å·ä¸­å¿ƒ"ï¼ŒæŸä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆï¼Œå°±å‘ä¿¡å·ä¸­å¿ƒ"å‘å¸ƒ"ï¼ˆpublishï¼‰ä¸€ä¸ªä¿¡å·ï¼Œå…¶ä»–ä»»åŠ¡å¯ä»¥å‘ä¿¡å·ä¸­å¿ƒ"è®¢é˜…"ï¼ˆsubscribeï¼‰è¿™ä¸ªä¿¡å·ï¼Œä»è€ŒçŸ¥é“ä»€ä¹ˆæ—¶å€™è‡ªå·±å¯ä»¥å¼€å§‹æ‰§è¡Œã€‚è¿™å°±å«åš"å‘å¸ƒ/è®¢é˜…æ¨¡å¼"ï¼ˆpublish-subscribe patternï¼‰ï¼Œåˆç§°"è§‚å¯Ÿè€…æ¨¡å¼"ï¼ˆobserver patternï¼‰ã€‚

è¿™ä¸ªæ¨¡å¼æœ‰å¤šç§å®ç°ï¼Œä¸‹é¢é‡‡ç”¨çš„æ˜¯ Ben Alman çš„ Tiny Pub/Subï¼Œè¿™æ˜¯ jQuery çš„ä¸€ä¸ªæ’ä»¶ã€‚

é¦–å…ˆï¼Œf2 å‘"ä¿¡å·ä¸­å¿ƒ"jQuery è®¢é˜…"done"ä¿¡å·ã€‚

```javascript
Query.subscribe("done", f2);

function f1() {
  setTimeout(function () {
    // f1çš„ä»»åŠ¡ä»£ç 

    jQuery.publish("done");
  }, 1000);
}
```

`jQuery.publish("done")`çš„æ„æ€æ˜¯ï¼Œf1 æ‰§è¡Œå®Œæˆåï¼Œå‘"ä¿¡å·ä¸­å¿ƒ"jQuery å‘å¸ƒ"done"ä¿¡å·ï¼Œä»è€Œå¼•å‘ f2 çš„æ‰§è¡Œã€‚

æ­¤å¤–ï¼Œf2 å®Œæˆæ‰§è¡Œåï¼Œä¹Ÿå¯ä»¥å–æ¶ˆè®¢é˜…ï¼ˆunsubscribeï¼‰ã€‚

```javascript
jQuery.unsubscribe("done", f2);
```

è¿™ç§æ–¹æ³•çš„æ€§è´¨ä¸"äº‹ä»¶ç›‘å¬"ç±»ä¼¼ï¼Œä½†æ˜¯æ˜æ˜¾ä¼˜äºåè€…ã€‚å› ä¸ºæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥çœ‹"æ¶ˆæ¯ä¸­å¿ƒ"ï¼Œäº†è§£å­˜åœ¨å¤šå°‘ä¿¡å·ã€æ¯ä¸ªä¿¡å·æœ‰å¤šå°‘è®¢é˜…è€…ï¼Œä»è€Œç›‘æ§ç¨‹åºçš„è¿è¡Œã€‚

### Promise

Promise æ˜¯ç°ä»£ JavaScript ä¸­å¼‚æ­¥ç¼–ç¨‹çš„åŸºç¡€ï¼Œæ˜¯ä¸€ä¸ªç”±å¼‚æ­¥å‡½æ•°è¿”å›çš„å¯ä»¥å‘æˆ‘ä»¬æŒ‡ç¤ºå½“å‰æ“ä½œæ‰€å¤„çš„çŠ¶æ€çš„å¯¹è±¡ã€‚åœ¨ Promise è¿”å›ç»™è°ƒç”¨è€…çš„æ—¶å€™ï¼Œæ“ä½œå¾€å¾€è¿˜æ²¡æœ‰å®Œæˆï¼Œä½† Promise å¯¹è±¡å¯ä»¥è®©æˆ‘ä»¬æ“ä½œæœ€ç»ˆå®Œæˆæ—¶å¯¹å…¶è¿›è¡Œå¤„ç†ï¼ˆæ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼‰

ç®€å•æ¥è¯´æ˜¯ js å®˜æ–¹æä¾›çš„ï¼Œå°è£…å¥½çš„å¼‚æ­¥æ–¹æ¡ˆï¼Œç”¨å°±å®Œäº†:relaxed:

> è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œå³ä½¿å·²ç»å®Œæˆäº†æ“ä½œ(æˆåŠŸæˆ–å¤±è´¥)ï¼Œæ‰å¯¹ Promise å¯¹è±¡ç»‘å®š`then`å‡½æ•°ï¼Œå®ƒä»¬éƒ½ä¼šå¦‚æœŸæ‰§è¡Œ

```typescript
console.log("start working");

const fetchPromise: Promise<Response> = fetch("http://bilibili.com");

console.log(fetchPromise);

fetchPromise.then((res: Response) => {
  console.log(res);
});

console.log("after sending...");

// start working
// Promise { <pending> }
// after sending...
// Response {
//   body: ReadableStream { locked: false },
//   bodyUsed: false,
//   headers: Headers {
//   "cache-control": "no-cache",
//   "content-type": "text/html; charset=utf-8",
//   date: "Wed, 11 Jan 2023 09:28:41 GMT",
//   expires: "Wed, 11 Jan 2023 09:28:40 GMT",
//   gear: "3",
//   "set-cookie": "b_nut=1673429321; path=/; expires=Thu, 11 Jan 2024 09:28:41 GMT; domain=.bilibili.com",
//   support: "nantianmen",
//   vary: "Origin,Accept-Encoding",
//   "x-cache-time": "0",
//   "x-cache-webcdn": "MISS from blzone03",
//   "x-origin-time": "no-cache, must-revalidate, max-age=0, no-store",
//   "x-save-date": "Wed, 11 Jan 2023 09:28:41 GMT"
// },
//   ok: true,
//   redirected: true,
//   status: 200,
//   statusText: "OK",
//   url: "https://www.bilibili.com/"
// }
```

ä½¿ç”¨`fetch` API,
æŠŠè¯·æ±‚`bilibili`è¿”å›çš„ Promise å¯¹è±¡ä¿å­˜ä¸‹æ¥ï¼Œç»™å®ƒæ·»åŠ  then å›è°ƒå‡½æ•°ï¼Œç”¨äºè¯·æ±‚æˆåŠŸåæ‰§è¡Œçš„æ“ä½œ

å¯ä»¥å‘ç°æˆ‘ä»¬å°è¯•è¾“å‡º Promise çš„æ—¶,æœ‰ä¸ª`pending`

Promise æœ‰ä¸‰ç§çŠ¶æ€ï¼š

- å¾…å®šï¼ˆpendingï¼‰ï¼šåˆå§‹çŠ¶æ€ï¼Œæ—¢æ²¡æœ‰è¢«å…‘ç°ï¼Œä¹Ÿæ²¡æœ‰è¢«æ‹’ç»ã€‚è¿™æ˜¯è°ƒç”¨ `fetch()` è¿”å› Promise æ—¶çš„çŠ¶æ€ï¼Œæ­¤æ—¶è¯·æ±‚è¿˜åœ¨è¿›è¡Œä¸­ã€‚
- å·²å…‘ç°ï¼ˆfulfilledï¼‰ï¼šæ„å‘³ç€æ“ä½œæˆåŠŸå®Œæˆã€‚å½“ Promise å®Œæˆæ—¶ï¼Œå®ƒçš„ `then()` å¤„ç†å‡½æ•°è¢«è°ƒç”¨ã€‚
- å·²æ‹’ç»ï¼ˆrejectedï¼‰ï¼šæ„å‘³ç€æ“ä½œå¤±è´¥ã€‚å½“ä¸€ä¸ª Promise å¤±è´¥æ—¶ï¼Œå®ƒçš„ `catch()` å¤„ç†å‡½æ•°è¢«è°ƒç”¨ã€‚

#### é“¾å¼

Promise çš„ä¸€ä¸ªä¼˜ç‚¹æ˜¯å¯ä»¥ä½¿ç”¨é“¾å¼çš„å†™æ³•ï¼Œå³ä¸€ä¸ª Promise å¯ä»¥ç»‘å®šå¤šä¸ª `then`, æˆ– `catch`

ä½¿ç”¨é“¾å¼çš„å†™æ³•ï¼Œå¯ä»¥é¿å…å›è°ƒå‡½æ•°çš„å¤šé‡åµŒå¥—, æ¯ä¸€ä¸ª then çš„è¿”å›å€¼éƒ½ä¼šä¼ è¿›ä¸‹ä¸€ä¸ª `then` é‡Œã€‚

å³ä½¿å†æ¬¡è¿›è¡Œå¤šæ¬¡è¯·æ±‚ä¹Ÿæ²¡å…³ç³»ï¼Œå†™æ³•ä¸ä¼šæ”¹å˜ï¼Œä¾ç„¶å¯ä»¥ä¿æŒé“¾å¼çš„ç»“æ„

> catch ç”¨äºæ•è·é”™è¯¯

```typescript
fetchPromise
  .then((res: Response) => {
    return res.url;
  })
  .then((url: string) => {
    return fetch(url);
  })
  .then((res: Response) => {
    console.log(res);
  })
  .catch((err: Error) => {
    console.error(err);
  });
```

### Promise API

#### Promise.all()

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å¿…é¡»ç­‰å¾…å¤šä¸ª promise å…¨éƒ¨å®ç°ï¼Œæ‰èƒ½è¿›è¡Œä¸€ä¸ªæ“ä½œ

ä½¿ç”¨ `Promise.all()`

- å½“ä¸”ä»…å½“æ•°ç»„ä¸­æ‰€æœ‰çš„ Promise éƒ½è¢«å…‘ç°æ—¶ï¼Œæ‰ä¼šé€šçŸ¥ `then()` å¤„ç†å‡½æ•°å¹¶æä¾›ä¸€ä¸ªåŒ…å«æ‰€æœ‰å“åº”çš„æ•°ç»„ï¼Œæ•°ç»„ä¸­å“åº”çš„é¡ºåºä¸è¢«ä¼ å…¥ `all()` çš„ `Promise` çš„é¡ºåºç›¸åŒ
- ä¼šè¢«æ‹’ç»â€”â€”å¦‚æœæ•°ç»„ä¸­æœ‰ä»»ä½•ä¸€ä¸ª Promise è¢«æ‹’ç»ã€‚æ­¤æ—¶ï¼Œ`catch()` å¤„ç†å‡½æ•°è¢«è°ƒç”¨ï¼Œå¹¶æä¾›è¢«æ‹’ç»çš„ Promise æ‰€æŠ›å‡ºçš„é”™è¯¯

```typescript
const promise1: Promise<Response> = fetch("https://www.bilibili.com");
const promise2: Promise<Response> = fetch("https://www.acfun.cn");
const promise3: Promise<Response> = fetch("https://www.youtube.com");

Promise.all([promise1, promise2, promise3])
  .then((responses: Response[]) => {
    for (const response of responses) {
      console.log(`${response.url}: ${response.status}`);
    }
  })
  .catch((err: Error) => {
    console.log(err);
  });

// https://www.bilibili.com/: 200
// https://www.acfun.cn/: 200
// https://www.youtube.com/: 200
```

#### Promise.any()

æœ‰æ—¶ï¼Œæˆ‘ä»¬åªéœ€è¦ç­‰å¾…å¤šä¸ª promise ä¹‹ä¸­çš„å…¶ä¸€å®Œæˆï¼Œä¾¿å¯æ‰§è¡Œ then æ“ä½œ

åªè¦å…¶ä¸­ä»»æ„ä¸€ä¸ª(æœ‰å¯èƒ½å¤šä¸ª)å®Œæˆ(fulfilled)ï¼Œå°±æ‰§è¡Œ thenï¼Œå…¨éƒ¨å¤±è´¥(rejected)æ‰æ‰§è¡Œ catch

```typescript
const promise1: Promise<Response> = fetch("https://www.bilibili.com");
const promise2: Promise<Response> = fetch("https://www.acfun.cn");
const promise3: Promise<Response> = fetch("https://www.youtube.com");

Promise.any([promise1, promise2, promise3]).then((resp: Response) => {
  console.log(`${resp.url} finish the job firstly.`);
});
```

#### Promise.race()

åªè¦æœ‰ä»»æ„ä¸€ä¸ª(æœ‰å¯èƒ½å¤šä¸ª), å®Œæˆ(fulfilled)æˆ–å¤±è´¥(rejected)ï¼Œåˆ™æ‰§è¡Œ then æˆ–æ‰§è¡Œ catch

#### async å’Œ await

æœ‰æ—¶å€™ï¼Œæˆ‘ä»¬å‘ç°ä½¿ç”¨é“¾å¼ promise çš„å†™æ³•ä¹Ÿä¸å¤Ÿç®€å•ï¼Œäºæ˜¯å®˜æ–¹æä¾›äº†æ›´ç®€ä¾¿çš„è¯­æ³•ç³– `await/async`

`async`:

ç®€å•ç‚¹ï¼Œ`async` ç”¨æ¥ä¿®é¥°ä¸€ä¸ª`function` è¯´æ˜è¿™ä¸ª `function` æ˜¯å¼‚æ­¥çš„, å³
æ‰§è¡Œåˆ°å®ƒæ—¶ï¼Œä¼šå…ˆæŠŠå‡½æ•°ä¸­ä¸éœ€è¦ç­‰å¾…çš„éƒ¨åˆ†æ‰§è¡Œï¼Œéœ€è¦ç­‰å¾…çš„éƒ¨åˆ†åˆ™æ˜¯è¢«`åˆ†æˆç‰‡æ®µæ”¾åœ¨"åå°"`æ‰§è¡Œäº†,ç„¶åç»§ç»­æ‰§è¡Œå‡½æ•°å¤–éç­‰å¾…çš„éƒ¨åˆ†

> è¿™é‡Œçš„åå°æœ‰ç‚¹ä¸å‡†ç¡®ï¼Œå…¶å® js æ˜¯å•çº¿ç¨‹æ‰§è¡Œçš„ï¼Œåªæ˜¯ cpu å¤„ç†çš„æ—¶å€™éœ€è¦å¿«é€Ÿåœ°åˆ‡æ¢æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼Œçœ‹èµ·æ¥å°±åƒæ˜¯å¹¶è¡Œçš„äº† :poop:

`await`:

- åªèƒ½åœ¨ç”¨åœ¨`async`å‡½æ•°ä¸­
- æ”¾åœ¨ä¸€ä¸ªè¿”å› promise çš„æ‰§è¡Œå‡½æ•°å‰,è¡¨ç¤ºç­‰å¾… promise `fulfilled` åï¼Œ æŠŠ`resolve`çš„å€¼è¿”å›

> å…¶å® `await` ä¸‹é¢çš„ä»£ç å°±ç›¸å½“äºè¿™ä¸ª `promise` çš„ `then` éƒ¨åˆ†, ç”¨èµ·æ¥æ˜¯ä¸æ˜¯æ›´æ–¹ä¾¿äº† :relaxed:

é‚£`rejected` çš„éƒ¨åˆ†æ€ä¹ˆåŠï¼Ÿ

- ç”¨ `try/catch` åŒ…è£¹èµ·æ¥å°±å¥½äº†!

```typescript
async function getWeb(url: string) {
  try {
    const resp = await fetch(url);
    console.log(`${resp.url}: ${resp.status}`);
    // ...
  } catch (error) {
    console.error(error);
  }
}

getWeb("https://www.bilibili.com");

// https://www.bilibili.com/: 200
```

### New Promise()

okï¼Œæ—¢ç„¶æˆ‘ä»¬å·²ç»ä¼šä½¿ç”¨ promise äº†ï¼Œè®©æˆ‘ä»¬æ¥å†™ä¸€ä¸ªç®€å•`Promise` å¯¹è±¡çš„çš„ä¾‹å­å§ï¼š

åŠŸèƒ½å¾ˆç®€å•ï¼Œå°±æ˜¯ç‚¹å‡»æŒ‰é’®ï¼Œé—´éš” 1s åæŠŠ `<h4>` æ ‡ç­¾çš„å†…å®¹æ¢æˆç‰›å«:

```vue{13,18,21}
<template>
  <h4>{{ show }}</h4>
  <button @click="handleClick">Click!</button
  ><button @click="show = 'Hello Cow !'">Reset</button>
</template>

<script setup lang="ts">
import { ref } from "vue";
const show = ref("Hello Cow !");

const callCowPromise = new Promise<T>((resolve: (value: T) => void) => {
    setTimeout(() => {
      resolve("ğŸ® Moo~");
    }, 1000);
});

function handleClick() {
callCowPromise.then((value: string)=>{
  show.value = value
})
  show.value = "Wait...";
}
</script>
```

> å¯ä»¥çœ‹åˆ°ï¼Œåœ¨`handleClick()`é‡Œå…ˆè®¾ç½®äº† `callCowPromise` çš„ `then` å‡½æ•°ï¼Œå†æ‰§è¡Œ `show.value =
"Wait..."`, è¿™éƒ¨åˆ†æ˜¯åŒæ­¥çš„å™¢

#### å±•ç¤ºï¼š

<h4>{{ show }}</h4>
  <button @click="handleClick">Click!</button
  ><button @click="show = 'Hello Cow !'">Reset</button>

<script setup lang='ts'>
import {ref } from "vue";
const show = ref("Hello Cow !");

const callCow = () => new Promise<T>((resolve: (value: T) => void) => {
    setTimeout(() => {
      resolve("ğŸ® Moo~");
    }, 1000);
});

async function handleClick() {
  show.value = "Wait...";
  show.value = await callCow();
}
</script>

> vuepress å¯ä»¥ç›´æ¥æ¸²æŸ“å‡ºæ¥æˆ‘ä»¬çš„ä»£ç  :relaxed:

<br/>

okï¼Œ ä»…é’ˆå¯¹ promise å¯¹è±¡è¯´æ˜ä¸€ä¸‹:

1. æˆ‘ä»¬åœ¨è¿™é‡Œåˆ›å»ºäº†ä¸€ä¸ª Promise å¯¹è±¡ `callCowPromise`, å®ƒä½¿ç”¨`Promise`ç±»çš„æ„é€ å‡½æ•° å®ƒè¿”å›ä¸€ä¸ª `Promise` å¯¹è±¡
2. æ„é€ å‡½æ•°å‚æ•°ä¸ºä¸€ä¸ªå›è°ƒå‡½æ•°,
   å› ä¸ºå†…å®¹ç®€å•ï¼Œåœ¨è¿™é‡Œæˆ‘æ‰§è¡Œå†™äº†å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°çš„å‚æ•°`resolve`ä¹Ÿæ˜¯ä¸ªå›è°ƒå‡½æ•°
3. ç¬¬ä¸€ä¸ªå›è°ƒå‡½æ•°ä¸­ï¼Œä½¿ç”¨`setTimeout`ç­‰å¾…ä¸€ç§’ï¼Œæ‰§è¡Œä¼ å…¥çš„å›è°ƒå‡½æ•°`resolve()`ï¼Œå†…å®¹ä¸ºç‰›å«ã€‚ok
   Promise åˆ›å»ºç»“æŸ
4. `callCowPromise`æ˜¯ä¸€ä¸ª`Promise`å¯¹è±¡ï¼Œé‚£ä¹ˆå¯ä»¥ç»™å®ƒåŠ ä¸Š`then`å‡½æ•°ï¼Œä½ å·²ç»æ³¨æ„åˆ°äº†ï¼Œ`then`å‡½æ•°ä¸­çš„å‚æ•°å³æ˜¯ `resolve` ä¼ å…¥çš„ç‰›å«

å†™ä¸€ä¸ª `promise` å¯¹è±¡æŒºç®€å•çš„å¯¹å§ï¼Œä½†å…¶å®è¿˜å¯ä»¥ä½¿ç”¨`async/await`ç®€åŒ–ä¸€ä¸‹æˆ‘ä»¬çš„ä»£ç :

```typescript
const callCow = () =>
  new Promise<T>((resolve: (value: T) => void) => {
    setTimeout(() => {
      resolve("ğŸ® Moo~");
    }, 1000);
  });

async function handleClick() {
  show.value = "Wait...";
  show.value = await callCow();
}
```

é¦–å…ˆ `await` åªèƒ½ç”¨åœ¨è¿”å›`promise`çš„å‡½æ•°ä¸Š, å› æ­¤æŠŠ`callCow`å˜æˆä¸€ä¸ªè¿”å›`promise`å¯¹è±¡çš„å‡½æ•°,
å…¶ä»–éƒ¨åˆ†ä¸ç”¨æ”¹ã€‚

ç„¶åï¼Œ`await` çš„ä½¿ç”¨å¿…é¡»åœ¨ `async` å‡½æ•°å†…ï¼Œå› æ­¤ä½¿ç”¨`async`ä¿®é¥°`handleClick`

ä½¿ç”¨`await` åœ¨`callCow()`å‰ï¼Œä½¿å¾—`await callCow()`è¿”å›çš„å€¼å˜æˆäº†`resolve()`é‡Œä¼ å…¥çš„ç‰›å«

å®Œæˆ :tada:

::: tip
å…³äº`async handleClick()` äº§ç”Ÿçš„å½±å“, `async` ä¼šæŠŠå‡½æ•°å˜ä¸ºå¼‚æ­¥çš„, å³è¿›å…¥å‡½æ•°åï¼Œå…ˆæ‰§è¡Œ `show.value = "Wait..."`
é‡åˆ°éœ€è¦ç­‰å¾…çš„æ“ä½œï¼Œåˆ™æŠŠå®ƒå¼‚æ­¥å¤„ç†ï¼ŒåŒæ—¶æ‰§è¡Œå‡½æ•°å¤–èƒ½é©¬ä¸Šæ‰§è¡Œçš„åŒæ­¥éƒ¨åˆ†ï¼Œè€Œå› ä¸º`handleClick`åªæ˜¯ä¸ªäº‹ä»¶å‡½æ•°ï¼Œä¸ä¼šå½±å“åˆ°ä¸Šä¸‹æ–‡çš„æ‰§è¡Œé¡ºåºï¼Œå› æ­¤æ²¡æœ‰å…³ç³»
:::

#### è¡¥å……

`resolve`ç”¨æ¥è¿”å›æ­£ç¡®çš„ç»“æœ, é‚£ä¹ˆé”™è¯¯çš„åŸå› ç”±`reject`æ¥è¿”å›

```typescript
const ezfunc = (value: string) =>
  new Promise<string>((resolve: (resp: string) => void, reject) => {
    if (value === "") reject(new Error("å€¼ä¸èƒ½ä¸ºç©ºï¼"));
    resolve(`<${value}>`);
  });

async function main() {
  try {
    console.log(await ezfunc("Hi â­ï¸"));
    console.log(await ezfunc(""));
  } catch (error) {
    console.error(error);
  }
}

main();

// <Hi â­ï¸>
// Error: å€¼ä¸èƒ½ä¸ºç©ºï¼
//     at file:///**/hello.ts:3:30
//     at new Promise (<anonymous>)
//     at ezfunc (file:///**/hello.ts:2:3)
//     at main (file:///**/hello.ts:10:23)
```

### workers

æ¯•ç«Ÿ js è¿˜æ˜¯å•çº¿ç¨‹çš„å˜›ï¼Œæœ‰äº›æƒ…å†µä¸‹ä¸èƒ½å¾ˆå¥½åœ°å‘æŒ¥å¤šæ ¸çš„æ€§èƒ½ï¼Œå› æ­¤ `workers` ç»™äº†æˆ‘ä»¬åœ¨ä¸åŒçº¿ç¨‹ä¸­è¿è¡ŒæŸäº›ä»»åŠ¡çš„èƒ½åŠ›

ä½†æ˜¯è¿™æ˜¯è¦ä»˜å‡ºä»£ä»·çš„ã€‚å¯¹äºå¤šçº¿ç¨‹ä»£ç ï¼Œä½ æ°¸è¿œä¸çŸ¥é“ä½ çš„çº¿ç¨‹ä»€ä¹ˆæ—¶å€™å°†ä¼šè¢«æŒ‚èµ·ï¼Œå…¶ä»–çº¿ç¨‹å°†ä¼šå¾—åˆ°è¿è¡Œçš„æœºä¼šã€‚å› æ­¤ï¼Œå¦‚æœä¸¤ä¸ªçº¿ç¨‹éƒ½å¯ä»¥è®¿é—®ç›¸åŒçš„å˜é‡ï¼Œé‚£ä¹ˆå˜é‡å°±æœ‰å¯èƒ½åœ¨ä»»ä½•æ—¶å€™å‘ç”Ÿæ„å¤–çš„å˜åŒ–ï¼Œè¿™å°†å¯¼è‡´å¾ˆéš¾å‘ç°çš„ Bug

ä¸ºäº†é¿å… Web ä¸­çš„è¿™äº›é—®é¢˜ï¼Œä½ çš„ä¸»ä»£ç å’Œä½ çš„ `worker` ä»£ç æ°¸è¿œä¸èƒ½ç›´æ¥è®¿é—®å½¼æ­¤çš„å˜é‡ã€‚`Workers` å’Œä¸»ä»£ç è¿è¡Œåœ¨å®Œå…¨åˆ†ç¦»çš„ç¯å¢ƒä¸­ï¼Œåªæœ‰é€šè¿‡ç›¸äº’å‘é€æ¶ˆæ¯æ¥è¿›è¡Œäº¤äº’ã€‚è¿™æ„å‘³ç€ `workers` ä¸èƒ½è®¿é—® `DOM`ï¼ˆçª—å£ã€æ–‡æ¡£ã€é¡µé¢å…ƒç´ ç­‰ç­‰ï¼‰

Worker çº¿ç¨‹æ— æ³•è¯»å–æœ¬åœ°æ–‡ä»¶ï¼Œå³ä¸èƒ½æ‰“å¼€æœ¬æœºçš„æ–‡ä»¶ç³»ç»Ÿï¼ˆfile://ï¼‰ï¼Œä¸”å®ƒæ‰€åŠ è½½çš„è„šæœ¬ï¼Œå¿…é¡»æ¥è‡ªç½‘ç»œã€‚

æœ‰ä¸‰ç±» workers:

- dedicated workers
- shared workers
- service workers

ä»…ä»‹ç»ç¬¬ä¸€ç±»

#### åˆ›å»º worker

åœ¨ä¸»çº¿ç¨‹ä¸­

```typescript
const worker = new Worker("ezworker.ts");
```

æ„é€ å‡½æ•°çš„å‚æ•°æ˜¯è„šæœ¬æ–‡ä»¶çš„åœ°å€ï¼Œè„šæœ¬å¿…é¡»æ¥è‡ªç½‘ç»œã€‚å¦‚æœä¸‹è½½æ²¡æœ‰æˆåŠŸï¼ˆæ¯”å¦‚ 404 é”™è¯¯ï¼‰ï¼ŒWorker å°±ä¼šé»˜é»˜åœ°å¤±è´¥

#### é€šä¿¡

è¦ä¸ worker äº’åŠ¨ï¼Œåªèƒ½é€šè¿‡å‘æ¶ˆæ¯çš„å½¢å¼

åœ¨ä¸»çº¿ç¨‹ä¸­, ä½¿ç”¨ `postMessage` å‘é€ä¸€æ¡æ¶ˆæ¯ç»™å­çº¿ç¨‹

```typescript
const worker = new Worker("ezworker.ts");

worker.postMessage("Hi my name is oooooooo");
```

postMessage å…¶å®æœ‰ä¸¤ä¸ªå‚æ•°

- message: æ™®é€šçš„æ¶ˆæ¯å¯ä»¥æ˜¯ä»»ä½•ç±»å‹, äºŒè¿›åˆ¶ä¹Ÿå¯ä»¥
- transferable objects: å¯è½¬ç§»å¯¹è±¡é€šå¸¸ç”¨äºå…±äº«èµ„æºï¼Œè¯¥èµ„æºä¸€æ¬¡ä»…èƒ½å®‰å…¨åœ°æš´éœ²åœ¨ä¸€ä¸ª JavaScript çº¿ç¨‹ä¸­

è¦æ¥æ”¶æ¥è‡ªå­çº¿ç¨‹çš„æ¶ˆæ¯, ä½¿ç”¨ `onmessage`æŒ‡å®šç›‘å¬å‡½æ•°

```typescript
worker.onmessage = (event: MessageEvent) => {
  console.log(`recv: ${event.data}`);
};
```

#### å…³é—­ worker

Worker çº¿ç¨‹ä¸€æ—¦æ–°å»ºæˆåŠŸï¼Œå°±ä¼šå§‹ç»ˆè¿è¡Œï¼Œå› æ­¤ä¸ºäº†é¿å…è¿‡åº¦æµªè´¹èµ„æºï¼Œ ä¸€æ—¦ä½¿ç”¨å®Œæ¯•ï¼Œå°±åº”è¯¥å…³é—­

ä¸»çº¿ç¨‹ä½¿ç”¨ `worker.terminate();` ç»“æŸ worker çº¿ç¨‹

worker çº¿ç¨‹ä½¿ç”¨ `self.close();` å…³é—­

#### worker

```typescript
self.onmessage = (event) => {
  self.postMessage(`ğŸ’©ğŸ’©ğŸ’©${event.data}ğŸ’©ğŸ’©ğŸ’©`);
};
```

#### ä¾‹å­

æ‡’å¾—å†™ï¼Œdeno çš„ worker å’ŒåŸç‰ˆçš„ä¸å¤ªä¸€æ · :poop:
